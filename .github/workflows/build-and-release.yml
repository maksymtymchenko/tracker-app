name: Build and Release

on:
  push:
    branches:
      - main
      - master
    tags:
      - "v*" # Triggers on version tags like v0.1.0, v1.0.0, etc.
  workflow_dispatch: # Allows manual triggering

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION="${{ github.ref_name }}"
            # Remove 'v' prefix if present
            VERSION=${VERSION#v}
          else
            # For branch pushes, use version from package.json
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "Ref: ${{ github.ref }}"
          echo "Ref type: ${{ github.ref_type }}"

      - name: Install dependencies
        run: npm install

      - name: Install electron-builder app dependencies
        run: npx electron-builder install-app-deps

      - name: Unblock app-builder.exe (Windows Defender workaround)
        shell: pwsh
        run: |
          $appBuilderPath = "node_modules\app-builder-bin\win\x64\app-builder.exe"
          if (Test-Path $appBuilderPath) {
            Unblock-File -Path $appBuilderPath -ErrorAction SilentlyContinue
            Write-Host "Unblocked app-builder.exe"
          }

      - name: Build application
        run: npm run build

      - name: Build Windows executables
        env:
          PUBLISH: never
        run: npm run dist:win -- --publish never

      - name: Install AWS CLI
        run: |
          choco install awscli -y

      - name: Upload to Cloudflare R2
        env:
          CLOUDFLARE_ACCESS_KEY_ID: ${{ secrets.CLOUDFLARE_ACCESS_KEY_ID }}
          CLOUDFLARE_SECRET_ACCESS_KEY: ${{ secrets.CLOUDFLARE_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          CURRENT_VERSION: ${{ steps.version.outputs.version }}
        shell: pwsh
        run: |
          # Configure AWS CLI for Cloudflare R2
          aws configure set aws_access_key_id $env:CLOUDFLARE_ACCESS_KEY_ID
          aws configure set aws_secret_access_key $env:CLOUDFLARE_SECRET_ACCESS_KEY

          # Clear old Windows files from bucket before uploading new ones
          Write-Host "Clearing old Windows files from bucket..."

          # Delete latest.yml files
          aws s3 rm "s3://$env:R2_BUCKET_NAME/latest.yml" --endpoint-url "$env:R2_ENDPOINT" || true
          aws s3 rm "s3://$env:R2_BUCKET_NAME/latest-win.yml" --endpoint-url "$env:R2_ENDPOINT" || true

          # Delete all .exe files (we'll upload new ones right after)
          Write-Host "Deleting all .exe files..."
          $output = aws s3 ls "s3://$env:R2_BUCKET_NAME/" --endpoint-url "$env:R2_ENDPOINT" 2>&1
          if ($LASTEXITCODE -eq 0 -and $output) {
            $exeFiles = $output | Select-String "\.exe" | ForEach-Object {
              $line = $_.Line.Trim()
              if ($line) {
                $parts = $line -split '\s+', 4
                if ($parts.Length -ge 4) {
                  $parts[3]
                } elseif ($parts.Length -ge 1) {
                  $parts[-1]
                }
              }
            }
            foreach ($file in $exeFiles) {
              if ($file -and $file -ne "") {
                Write-Host "Deleting: $file"
                aws s3 rm "s3://$env:R2_BUCKET_NAME/$file" --endpoint-url "$env:R2_ENDPOINT" 2>&1 | Out-Null
              }
            }
          }

          # Delete all .blockmap files (they'll be regenerated)
          Write-Host "Deleting all .blockmap files..."
          $output = aws s3 ls "s3://$env:R2_BUCKET_NAME/" --endpoint-url "$env:R2_ENDPOINT" 2>&1
          if ($LASTEXITCODE -eq 0 -and $output) {
            $blockmapFiles = $output | Select-String "\.blockmap" | ForEach-Object {
              $line = $_.Line.Trim()
              if ($line) {
                $parts = $line -split '\s+', 4
                if ($parts.Length -ge 4) {
                  $parts[3]
                } elseif ($parts.Length -ge 1) {
                  $parts[-1]
                }
              }
            }
            foreach ($file in $blockmapFiles) {
              if ($file -and $file -ne "") {
                Write-Host "Deleting: $file"
                aws s3 rm "s3://$env:R2_BUCKET_NAME/$file" --endpoint-url "$env:R2_ENDPOINT" 2>&1 | Out-Null
              }
            }
          }

          Write-Host "Old Windows files cleared"

          # Upload latest.yml to tracker-app-auto-update subdirectory
          if (Test-Path "release\latest.yml") {
            aws s3 cp "release\latest.yml" "s3://$env:R2_BUCKET_NAME/latest-win.yml" `
              --endpoint-url "$env:R2_ENDPOINT" `
              --content-type "text/yaml"
            
            # Also upload as latest.yml for generic provider
            aws s3 cp "release\latest.yml" "s3://$env:R2_BUCKET_NAME/latest.yml" `
              --endpoint-url "$env:R2_ENDPOINT" `
              --content-type "text/yaml"
          }

          # Upload all .exe files to tracker-app-auto-update subdirectory
          Get-ChildItem -Path "release" -Filter "*.exe" | ForEach-Object {
            Write-Host "Uploading $($_.Name)"
            aws s3 cp $_.FullName "s3://$env:R2_BUCKET_NAME/$($_.Name)" `
              --endpoint-url "$env:R2_ENDPOINT"
          }

          # Upload .blockmap files if they exist
          Get-ChildItem -Path "release" -Filter "*.blockmap" | ForEach-Object {
            Write-Host "Uploading $($_.Name)"
            aws s3 cp $_.FullName "s3://$env:R2_BUCKET_NAME/$($_.Name)" `
              --endpoint-url "$env:R2_ENDPOINT"
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: release/*.exe
          retention-days: 30

  build-macos:
    name: Build macOS
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Get version
        id: version
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION="${{ github.ref_name }}"
            # Remove 'v' prefix if present
            VERSION=${VERSION#v}
          else
            # For branch pushes, use version from package.json
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "Ref: ${{ github.ref }}"
          echo "Ref type: ${{ github.ref_type }}"

      - name: Install dependencies
        run: npm install

      - name: Build application
        run: npm run build

      - name: Build macOS app
        env:
          PUBLISH: never
        run: npm run build && npx electron-builder --mac --publish never

      - name: Install AWS CLI
        run: |
          brew install awscli || pip3 install awscli

      - name: Upload to Cloudflare R2
        env:
          CLOUDFLARE_ACCESS_KEY_ID: ${{ secrets.CLOUDFLARE_ACCESS_KEY_ID }}
          CLOUDFLARE_SECRET_ACCESS_KEY: ${{ secrets.CLOUDFLARE_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          CURRENT_VERSION: ${{ steps.version.outputs.version }}
        run: |
          # Configure AWS CLI for Cloudflare R2
          aws configure set aws_access_key_id $CLOUDFLARE_ACCESS_KEY_ID
          aws configure set aws_secret_access_key $CLOUDFLARE_SECRET_ACCESS_KEY

          # Clear old macOS files from bucket before uploading new ones
          echo "Clearing old macOS files from bucket..."

          # Delete latest-mac.yml
          aws s3 rm "s3://$R2_BUCKET_NAME/latest-mac.yml" --endpoint-url "$R2_ENDPOINT" || true

          # Delete all .dmg files (we'll upload new ones right after)
          echo "Deleting all .dmg files..."
          dmg_files=$(aws s3 ls "s3://$R2_BUCKET_NAME/" --endpoint-url "$R2_ENDPOINT" | grep "\.dmg$" | awk '{print $4}')
          for file in $dmg_files; do
            if [ -n "$file" ]; then
              echo "Deleting: $file"
              aws s3 rm "s3://$R2_BUCKET_NAME/$file" --endpoint-url "$R2_ENDPOINT" || true
            fi
          done

          # Delete all -mac.zip files (we'll upload new ones right after)
          echo "Deleting all -mac.zip files..."
          zip_files=$(aws s3 ls "s3://$R2_BUCKET_NAME/" --endpoint-url "$R2_ENDPOINT" | grep "-mac.zip$" | awk '{print $4}')
          for file in $zip_files; do
            if [ -n "$file" ]; then
              echo "Deleting: $file"
              aws s3 rm "s3://$R2_BUCKET_NAME/$file" --endpoint-url "$R2_ENDPOINT" || true
            fi
          done

          echo "Old macOS files cleared"

          # Upload latest-mac.yml to tracker-app-auto-update subdirectory
          if [ -f "release/latest-mac.yml" ]; then
            aws s3 cp "release/latest-mac.yml" "s3://$R2_BUCKET_NAME/latest-mac.yml" \
              --endpoint-url "$R2_ENDPOINT" \
              --content-type "text/yaml"
          fi

          # Upload all DMG files to tracker-app-auto-update subdirectory
          for dmg in release/*.dmg; do
            if [ -f "$dmg" ]; then
              echo "Uploading $(basename "$dmg")"
              aws s3 cp "$dmg" "s3://$R2_BUCKET_NAME/$(basename "$dmg")" \
                --endpoint-url "$R2_ENDPOINT"
            fi
          done

          # Upload all ZIP files to tracker-app-auto-update subdirectory
          for zip in release/*-mac.zip; do
            if [ -f "$zip" ]; then
              echo "Uploading $(basename "$zip")"
              aws s3 cp "$zip" "s3://$R2_BUCKET_NAME/$(basename "$zip")" \
                --endpoint-url "$R2_ENDPOINT"
            fi
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: release/*.{dmg,zip}
          retention-days: 30
