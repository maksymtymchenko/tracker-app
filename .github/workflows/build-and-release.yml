name: Build and Release

on:
  push:
    branches:
      - main
      - master
    tags:
      - "v*" # Triggers on version tags like v0.1.0, v1.0.0, etc.
  workflow_dispatch: # Allows manual triggering

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION="${{ github.ref_name }}"
            # Remove 'v' prefix if present
            VERSION=${VERSION#v}
          else
            # For branch pushes, use version from package.json
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "Ref: ${{ github.ref }}"
          echo "Ref type: ${{ github.ref_type }}"

      - name: Install dependencies
        run: npm install

      - name: Install electron-builder app dependencies
        run: npx electron-builder install-app-deps

      - name: Setup Python for node-gyp (distutils required; 3.12+ removed it)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Rebuild native modules
        run: npm run rebuild

      - name: Unblock app-builder.exe (Windows Defender workaround)
        shell: pwsh
        run: |
          $appBuilderPath = "node_modules\app-builder-bin\win\x64\app-builder.exe"
          if (Test-Path $appBuilderPath) {
            Unblock-File -Path $appBuilderPath -ErrorAction SilentlyContinue
            Write-Host "Unblocked app-builder.exe"
          }

      - name: Build application
        run: npm run build

      - name: Build Windows executables
        env:
          PUBLISH: never
        run: npm run dist:win -- --publish never

      - name: Install AWS CLI
        run: |
          choco install awscli -y

      - name: Upload to Cloudflare R2
        env:
          CLOUDFLARE_ACCESS_KEY_ID: ${{ secrets.CLOUDFLARE_ACCESS_KEY_ID }}
          CLOUDFLARE_SECRET_ACCESS_KEY: ${{ secrets.CLOUDFLARE_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          CURRENT_VERSION: ${{ steps.version.outputs.version }}
        shell: pwsh
        run: |
          # Configure AWS CLI for Cloudflare R2
          aws configure set aws_access_key_id $env:CLOUDFLARE_ACCESS_KEY_ID
          aws configure set aws_secret_access_key $env:CLOUDFLARE_SECRET_ACCESS_KEY

          # Clear all files from bucket before uploading new ones
          Write-Host "Clearing all files from bucket..."
          aws s3 rm "s3://$env:R2_BUCKET_NAME/" --recursive --endpoint-url "$env:R2_ENDPOINT" || true
          Write-Host "Bucket cleared, ready to upload new files"

          # Upload latest.yml to tracker-app-auto-update subdirectory
          if (Test-Path "release\latest.yml") {
            aws s3 cp "release\latest.yml" "s3://$env:R2_BUCKET_NAME/latest-win.yml" `
              --endpoint-url "$env:R2_ENDPOINT" `
              --content-type "text/yaml"
            
            # Also upload as latest.yml for generic provider
            aws s3 cp "release\latest.yml" "s3://$env:R2_BUCKET_NAME/latest.yml" `
              --endpoint-url "$env:R2_ENDPOINT" `
              --content-type "text/yaml"
          }

          # Upload all .exe files to tracker-app-auto-update subdirectory
          Get-ChildItem -Path "release" -Filter "*.exe" | ForEach-Object {
            Write-Host "Uploading $($_.Name)"
            aws s3 cp $_.FullName "s3://$env:R2_BUCKET_NAME/$($_.Name)" `
              --endpoint-url "$env:R2_ENDPOINT"
          }

          # Upload .blockmap files if they exist
          Get-ChildItem -Path "release" -Filter "*.blockmap" | ForEach-Object {
            Write-Host "Uploading $($_.Name)"
            aws s3 cp $_.FullName "s3://$env:R2_BUCKET_NAME/$($_.Name)" `
              --endpoint-url "$env:R2_ENDPOINT"
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: release/*.exe
          retention-days: 30
